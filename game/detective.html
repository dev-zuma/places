<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Worldwide Chase - Investigation File</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="game-container">
        <!-- Loading State -->
        <div class="loading-container" id="loadingContainer">
            <div class="loading-spinner"></div>
            <h3>Loading Case File...</h3>
            <p>Gathering evidence and witness reports</p>
        </div>

        <!-- Error State -->
        <div class="error-container hidden" id="errorContainer">
            <h2>Case Not Found</h2>
            <p>The requested case file could not be located in our database.</p>
            <button class="back-button" onclick="window.location.href = 'index.html'">
                ‚Üê Back to Chase Gallery
            </button>
        </div>

        <!-- Main Game Interface (initially hidden) -->
        <div id="gameInterface" class="hidden">
            <!-- Detective Header Container (injected by detective-header.js) -->
            <div id="detective-header-container"></div>

            <!-- Turn Indicator (moved above tabs) -->
            <div class="turn-indicator-container">
                <div class="turn-indicator">
                    <div class="turn-progress-line">
                        <div class="turn-progress-fill" id="progressFill"></div>
                    </div>
                    <div class="turn-dot active turn-1" id="turn1">1</div>
                    <div class="turn-dot no-image" id="turn2">2</div>
                    <div class="turn-dot" id="turn3">3</div>
                    <div class="turn-dot no-image" id="turn4">4</div>
                    <div class="turn-dot" id="turn5">5</div>
                </div>
            </div>

            <!-- Detective File Tabs -->
            <div class="detective-tabs">
                <div class="tabs-left">
                    <button class="tab-button active" id="caseDetailsTab" onclick="switchTab('caseDetails')">
                        Case Details
                    </button>
                    <button class="tab-button" id="cluesTab" onclick="switchTab('clues')">
                        Clues
                    </button>
                    <button class="tab-button" id="investigationTab" onclick="switchTab('investigation')">
                        Check Answers
                    </button>
                </div>
                <div class="tabs-right">
                    <div class="timer-display">
                        <div class="timer-label">TIME</div>
                        <div class="timer-value" id="timerValue">00:00</div>
                    </div>
                </div>
            </div>

            <!-- Tab Content -->
            <div class="tab-content">
                <!-- Case Details Tab -->
                <div class="tab-panel active" id="caseDetailsPanel">
                    <div class="case-file-layout">
                        <!-- Villain Profile -->
                        <div class="villain-profile">
                            <div class="villain-mugshot">
                                <img id="villainPortrait" alt="" class="villain-portrait clickable" onclick="showVillainModal()">
                                <div class="mugshot-label">SUSPECT</div>
                            </div>
                            <div class="villain-info">
                                <h3 id="villainName"></h3>
                                <p class="villain-title" id="villainTitle"></p>
                            </div>
                        </div>

                        <!-- Case Summary -->
                        <div class="case-section crime-summary">
                            <h4>Case Summary</h4>
                            <p id="crimeSummary"></p>
                        </div>
                        
                    </div>
                </div>

                <!-- Clues Tab -->
                <div class="tab-panel" id="cluesPanel">
                    <div class="clues-board">
                        <div class="clues-header">
                            <h3>Investigation Journal</h3>
                            <p class="clues-subtitle">Evidence and discoveries from your investigation</p>
                            <div class="view-toggle">
                                <button class="view-toggle-btn active" onclick="switchCluesView('timeline')">
                                    <span class="view-icon">üìÖ</span> Timeline
                                </button>
                                <button class="view-toggle-btn" onclick="switchCluesView('locations')">
                                    <span class="view-icon">üìç</span> Locations
                                </button>
                            </div>
                        </div>
                        
                        <!-- Timeline View -->
                        <div class="clues-view" id="timelineView">
                            <div class="timeline-container" id="timelineContainer">
                                <!-- Timeline entries will be populated here -->
                            </div>
                        </div>
                        
                        <!-- Locations View -->
                        <div class="clues-view hidden" id="locationsView">
                            <div class="locations-dossiers" id="locationsDossiers">
                                <!-- Location dossiers will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Check Answers Tab -->
                <div class="tab-panel" id="investigationPanel">
                    <div class="game-area">
                        <div class="locations-container" id="locationsContainer">
                            <!-- Locations will be populated dynamically -->
                        </div>
                        <div class="action-button-container">
                            <button class="action-button turn-1" id="actionButton" onclick="submitEvidence()">
                                Analyze Evidence
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" class="image-modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeImageModal()">&times;</button>
            <div class="modal-header" id="modalHeader">Evidence Photo</div>
            <img id="modalImage" class="modal-image" src="" alt="Evidence">
        </div>
    </div>
    
    <!-- End Game Modal -->
    <div id="endGameModal" class="image-modal">
        <div class="modal-content end-game-modal-content">
            <button class="modal-close" onclick="closeEndGameModal()">&times;</button>
            <div class="modal-header" id="endGameHeader">CASE CLOSED</div>
            <div id="endGameContent" class="end-game-content">
                <!-- Content will be populated dynamically -->
            </div>
            <div class="end-game-actions">
                <button class="action-button end-game-button" onclick="playAgain()">
                    New Case
                </button>
                <button class="action-button end-game-button" onclick="viewResults()">
                    View Results
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentCase = null;
        let gameData = null;
        let currentTurn = 1;
        let activeTab = 'caseDetails';
        let correctLocations = [false, false, false]; // Track which locations have been guessed
        let gameScore = 0;
        let gameStartTime = null;

        // Load case data on page load
        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            let caseId = urlParams.get('caseId') || urlParams.get('case');
            
            // If no case ID provided, load a random case
            if (!caseId) {
                const cases = await loadRandomCase();
                if (cases && cases.length > 0) {
                    // Pick a random case
                    const randomCase = cases[Math.floor(Math.random() * cases.length)];
                    caseId = randomCase.id;
                    // Update URL without reload
                    window.history.replaceState({}, '', `?caseId=${caseId}`);
                } else {
                    showError('No cases available');
                    return;
                }
            }
            
            await loadCase(caseId);
        });
        
        async function loadRandomCase() {
            try {
                const response = await fetch('/api/cases');
                if (!response.ok) {
                    throw new Error('Failed to fetch cases');
                }
                return await response.json();
            } catch (error) {
                console.error('Error loading cases:', error);
                return null;
            }
        }

        async function loadCase(caseId) {
            try {
                const response = await fetch('/api/cases');
                
                if (!response.ok) {
                    throw new Error('Failed to fetch cases');
                }
                
                const cases = await response.json();
                currentCase = cases.find(c => c.id === caseId);
                
                if (!currentCase) {
                    showError('Case not found');
                    return;
                }
                
                initializeGame();
                
            } catch (error) {
                console.error('Error loading case:', error);
                showError('Failed to load case data');
            }
        }

        function initializeGame() {
            // Hide loading, show game
            document.getElementById('loadingContainer').classList.add('hidden');
            document.getElementById('gameInterface').classList.remove('hidden');
            document.getElementById('gameInterface').classList.add('show-flex', 'flex-column', 'flex-height');
            
            // Set gameData for villain modal
            gameData = currentCase;
            
            // Populate case header
            document.getElementById('caseTitle').textContent = currentCase.caseTitle;
            document.getElementById('themeBadge').textContent = currentCase.theme;
            
            // Populate case details
            const villainPortrait = document.getElementById('villainPortrait');
            villainPortrait.src = currentCase.villainImageUrl || `https://ui-avatars.com/api/?name=${encodeURIComponent(currentCase.villainName.charAt(0))}&size=60&background=7c2d12&color=fff&bold=true&rounded=true`;
            villainPortrait.alt = currentCase.villainName;
            
            document.getElementById('villainName').textContent = currentCase.villainName;
            document.getElementById('villainTitle').textContent = currentCase.villainTitle;
            document.getElementById('crimeSummary').textContent = currentCase.crimeSummary;
            
            // Generate locations
            generateLocations();
            
            // Initialize game state
            updateTurnDisplay();
            updateActionButtonState();
            
            // Initialize timeline
            timelineEntries = [];
            
            // Add Turn 1 images to timeline
            if (currentCase.locations) {
                const turn1Images = currentCase.locations.map(loc => 
                    loc.images && loc.images.turn1
                ).filter(img => img);
                
                if (turn1Images.length > 0) {
                    addTimelineEntry(1, 'images', null, {
                        images: turn1Images,
                        turn: 1
                    });
                }
            }
            
            updateTimelineView();
            
            // Start the timer and record start time
            gameStartTime = new Date();
            startTimer();
        }

        function generateLocations() {
            const container = document.getElementById('locationsContainer');
            const locations = currentCase.locations;
            
            container.innerHTML = '';
            
            // Create simplified layout for Check Answers tab
            locations.forEach((location, index) => {
                // Create simple location input
                const locationDiv = document.createElement('div');
                locationDiv.className = 'simple-location-input';
                locationDiv.id = `place${location.position}`;
                
                // Create input boxes for the location name with word spacing
                const words = location.name.split(' ');
                const inputBoxesHTML = words.map(word => {
                    const boxes = word.split('').map(() => 
                        '<input type="text" class="letter-box" value="" maxlength="1">'
                    ).join('');
                    return `<div class="word-group">${boxes}</div>`;
                }).join('');
                
                locationDiv.innerHTML = `
                    <div class="simple-location-label">Location ${location.position}</div>
                    <div class="input-container">
                        ${inputBoxesHTML}
                    </div>
                `;
                
                container.appendChild(locationDiv);
            });
            
            // Add input event listeners
            setupInputHandlers();
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of the Earth in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function setupInputHandlers() {
            const inputs = document.querySelectorAll('.letter-box');
            inputs.forEach((input, index) => {
                input.addEventListener('input', function() {
                    if (this.value.length === 1) {
                        this.classList.add('filled');
                        const nextInput = this.nextElementSibling;
                        if (nextInput && nextInput.classList.contains('letter-box') && !nextInput.value) {
                            nextInput.focus();
                        }
                    } else {
                        this.classList.remove('filled');
                    }
                });
                
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Backspace' && !this.value) {
                        const prevInput = this.previousElementSibling;
                        if (prevInput && prevInput.classList.contains('letter-box')) {
                            prevInput.focus();
                        }
                    }
                });
            });
        }

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
            
            if (tabName === 'caseDetails') {
                document.getElementById('caseDetailsTab').classList.add('active');
                document.getElementById('caseDetailsPanel').classList.add('active');
            } else if (tabName === 'clues') {
                document.getElementById('cluesTab').classList.add('active');
                document.getElementById('cluesPanel').classList.add('active');
            } else if (tabName === 'investigation') {
                document.getElementById('investigationTab').classList.add('active');
                document.getElementById('investigationPanel').classList.add('active');
            }
            
            activeTab = tabName;
            
            // Enable/disable action button based on tab
            updateActionButtonState();
        }
        
        function updateActionButtonState() {
            const actionButton = document.getElementById('actionButton');
            if (activeTab === 'caseDetails' || activeTab === 'clues') {
                actionButton.disabled = true;
                actionButton.textContent = '‚Üí Go to Check Answers';
                actionButton.title = 'Switch to Check Answers tab to analyze evidence and submit answers';
            } else {
                actionButton.disabled = false;
                actionButton.title = '';
                // Restore normal button text
                const turnInfo = turnData[currentTurn];
                if (turnInfo) {
                    actionButton.textContent = turnInfo.action;
                }
            }
        }

        const turnData = {
            1: { 
                action: "Turn 1 Check",
                evidence: "Initial surveillance footage collected from all three locations. Images show key identifying features but remain partially obscured."
            },
            2: { 
                action: "Turn 2 Check",
                evidence: "Time zone analysis reveals the suspect moved between locations during different local times, creating a timeline of the chase."
            },
            3: { 
                action: "Turn 3 Check",
                evidence: "Additional surveillance footage reveals clearer details and patterns linking the locations in the worldwide chase."
            },
            4: { 
                action: "Turn 4 Check",
                evidence: () => `Breakthrough! The key connection discovered: "${currentCase?.turn4Clue || 'MYSTERY'}". All locations share this critical element in the chase.`
            },
            5: { 
                action: "Final Check",
                evidence: "Final surveillance footage provides clear identifying features of all locations. Ready to close the worldwide chase."
            }
        };

        let gameTimer = 0; // Count up from 0 seconds
        let timerInterval = null;
        
        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                gameTimer++;
                updateTimerDisplay();
            }, 1000);
        }
        
        function updateTimerDisplay() {
            const minutes = Math.floor(gameTimer / 60);
            const seconds = gameTimer % 60;
            const timerValue = document.getElementById('timerValue');
            if (timerValue) {
                timerValue.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // Reset colors for count-up timer
                timerValue.style.color = 'var(--primary-orange)';
                timerValue.style.borderColor = 'var(--primary-orange)';
            }
        }
        
        function updateTurnDisplay() {
            const dots = document.querySelectorAll('.turn-dot');
            const progressFill = document.getElementById('progressFill');
            const actionButton = document.getElementById('actionButton');
            
            // Update progress bar
            const progressWidths = { 1: '0%', 2: '25%', 3: '50%', 4: '75%', 5: '100%' };
            progressFill.style.width = progressWidths[currentTurn];
            
            // Update turn dots
            dots.forEach((dot, index) => {
                const turnNumber = index + 1;
                dot.classList.remove('active', 'completed', 'turn-1', 'turn-2', 'turn-3', 'turn-4', 'turn-5');
                
                if (turnNumber < currentTurn) {
                    dot.classList.add('completed', `turn-${turnNumber}`);
                } else if (turnNumber === currentTurn) {
                    dot.classList.add('active', `turn-${turnNumber}`);
                } else {
                    // Keep original turn color for inactive dots
                    if (turnNumber === 2 || turnNumber === 4) {
                        dot.classList.add('no-image');
                    }
                    dot.classList.add(`turn-${turnNumber}`);
                }
            });
            
            // Add geographic data to timeline at Turn 2
            if (currentTurn >= 2) {
                const hasGeographic = timelineEntries.some(e => e.turn === 2 && e.type === 'geographic');
                if (!hasGeographic) {
                    const locations = currentCase.locations;
                    const distances = [
                        { from: 0, to: 1, name: 'Loc 1‚Üî2', km: Math.round(calculateDistance(locations[0].latitude, locations[0].longitude, locations[1].latitude, locations[1].longitude)), miles: Math.round(calculateDistance(locations[0].latitude, locations[0].longitude, locations[1].latitude, locations[1].longitude) * 0.621371) },
                        { from: 1, to: 2, name: 'Loc 2‚Üî3', km: Math.round(calculateDistance(locations[1].latitude, locations[1].longitude, locations[2].latitude, locations[2].longitude)), miles: Math.round(calculateDistance(locations[1].latitude, locations[1].longitude, locations[2].latitude, locations[2].longitude) * 0.621371) },
                        { from: 0, to: 2, name: 'Loc 1‚Üî3', km: Math.round(calculateDistance(locations[0].latitude, locations[0].longitude, locations[2].latitude, locations[2].longitude)), miles: Math.round(calculateDistance(locations[0].latitude, locations[0].longitude, locations[2].latitude, locations[2].longitude) * 0.621371) }
                    ];
                    const timezones = locations.map(loc => ({
                        location: `Loc ${loc.position}`,
                        offset: `UTC${loc.timezoneOffset >= 0 ? '+' : ''}${loc.timezoneOffset}`
                    }));
                    
                    addTimelineEntry(2, 'geographic', null, {
                        geographic: { distances, timezones }
                    });
                }
            }
            
            // Handle Turn 4 clue display
            if (currentTurn >= 4) {
                showTurn4Clue();
            } else {
                hideTurn4Clue();
            }
            
            // Update evidence images in timeline
            if (currentTurn === 1 || currentTurn === 3 || currentTurn === 5) {
                const hasImages = timelineEntries.some(e => e.turn === currentTurn && e.type === 'images');
                if (!hasImages && currentCase.locations) {
                    const images = currentCase.locations.map(loc => 
                        loc.images && loc.images[`turn${currentTurn}`]
                    ).filter(img => img);
                    
                    if (images.length > 0) {
                        addTimelineEntry(currentTurn, 'images', null, {
                            images,
                            turn: currentTurn
                        });
                    }
                }
            }
            
            // Update views
            if (cluesViewMode === 'timeline') {
                updateTimelineView();
            } else {
                updateLocationsView();
            }
            
            // Update action button
            const turnInfo = turnData[currentTurn];
            actionButton.textContent = turnInfo.action;
            actionButton.className = `action-button turn-${currentTurn}`;
        }

        function updateImageDisplay() {
            const imageContainers = document.querySelectorAll('.image-container');
            
            imageContainers.forEach(container => {
                container.classList.remove('current');
                
                // Highlight current turn's images
                if ((container.classList.contains('turn-1') && currentTurn === 1) ||
                    (container.classList.contains('turn-3') && currentTurn === 3) ||
                    (container.classList.contains('turn-5') && currentTurn === 5)) {
                    container.classList.add('current');
                }
                
                // Show appropriate images based on turn
                const locationIndex = Array.from(container.closest('.location-section').parentNode.children)
                    .filter(el => el.classList.contains('location-section'))
                    .indexOf(container.closest('.location-section'));
                const location = currentCase.locations[locationIndex];
                
                if (container.classList.contains('turn-3') && currentTurn >= 3 && location.images.turn3) {
                    if (container.querySelector('.image-placeholder')) {
                        container.innerHTML = `
                            <img src="${location.images.turn3}" alt="Turn 3 evidence">
                            <div class="turn-badge turn-3">T3</div>
                        `;
                    }
                } else if (container.classList.contains('turn-5') && currentTurn >= 5 && location.images.turn5) {
                    if (container.querySelector('.image-placeholder')) {
                        container.innerHTML = `
                            <img src="${location.images.turn5}" alt="Turn 5 evidence">
                            <div class="turn-badge turn-5">T5</div>
                        `;
                    }
                }
            });
        }

        function addEvidence(turn, content) {
            // Add to timeline system
            if (turn === 4 && currentCase.turn4Clue) {
                addTimelineEntry(turn, 'breakthrough', content, { clue: currentCase.turn4Clue });
            } else {
                addTimelineEntry(turn, 'text', content);
            }
        }

        function submitEvidence() {
            const turnInfo = turnData[currentTurn];
            
            // Check answers for each location
            checkLocationAnswers();
            
            // Add evidence to case file
            const evidenceText = typeof turnInfo.evidence === 'function' ? turnInfo.evidence() : turnInfo.evidence;
            addEvidence(currentTurn, evidenceText);
            
            // Show evidence notification if on investigation tab
            if (activeTab === 'investigation') {
                showEvidenceNotification(currentTurn);
            }
            
            // Check if all locations are correct (early completion)
            const allCorrect = correctLocations.every(loc => loc === true);
            if (allCorrect) {
                // Game completed early!
                setTimeout(() => {
                    endGame();
                }, 1000);
                return;
            }
            
            // Progress to next turn or end game
            if (currentTurn < 5) {
                setTimeout(() => {
                    currentTurn++;
                    updateTurnDisplay();
                }, 1000);
            } else {
                // Game ended at Turn 5!
                setTimeout(() => {
                    endGame();
                }, 1000);
            }
        }
        
        function checkLocationAnswers() {
            currentCase.locations.forEach((location, index) => {
                if (!correctLocations[index]) { // Only check if not already correct
                    const inputContainers = document.querySelectorAll(`#place${location.position} .input-container`);
                    const wordGroups = inputContainers[0].querySelectorAll('.word-group');
                    
                    // Reconstruct the entered answer
                    let enteredAnswer = '';
                    wordGroups.forEach((group, groupIndex) => {
                        if (groupIndex > 0) enteredAnswer += ' '; // Add space between words
                        const letterBoxes = group.querySelectorAll('.letter-box');
                        letterBoxes.forEach(box => {
                            enteredAnswer += box.value.toUpperCase();
                        });
                    });
                    
                    // Check if answer is correct
                    if (enteredAnswer.trim() === location.name.toUpperCase()) {
                        // Mark as correct
                        correctLocations[index] = true;
                        
                        // Lock the inputs and style them as correct
                        const letterBoxes = inputContainers[0].querySelectorAll('.letter-box');
                        letterBoxes.forEach(box => {
                            box.classList.add('correct');
                            box.disabled = true;
                        });
                        
                        // Calculate score based on turn (more points for earlier guesses)
                        const turnScore = (6 - currentTurn) * 100;
                        
                        // Add early completion bonus if completed before Turn 5
                        let bonusPoints = 0;
                        if (correctLocations.every(loc => loc === true) && currentTurn < 5) {
                            bonusPoints = (5 - currentTurn) * 50; // 50 points per turn saved
                            gameScore += bonusPoints;
                        }
                        gameScore += turnScore;
                    } else {
                        // Clear incorrect inputs
                        const letterBoxes = inputContainers[0].querySelectorAll('.letter-box');
                        letterBoxes.forEach(box => {
                            box.value = '';
                            box.classList.remove('filled');
                        });
                    }
                }
            });
        }

        function endGame() {
            const allCorrect = correctLocations.every(loc => loc === true);
            const timeTaken = gameTimer; // Use actual elapsed time
            const minutes = Math.floor(timeTaken / 60);
            const seconds = timeTaken % 60;
            
            // Clear timer
            if (timerInterval) clearInterval(timerInterval);
            
            // Build modal content
            let modalContent = '';
            
            if (allCorrect) {
                // All locations correct - show CAPTURED
                modalContent = `
                    <div class="villain-capture">
                        <img src="${currentCase.villainImageUrl || `https://ui-avatars.com/api/?name=${encodeURIComponent(currentCase.villainName.charAt(0))}&size=200&background=7c2d12&color=fff&bold=true&rounded=false`}" alt="${currentCase.villainName}">
                        <div class="captured-stamp">CAPTURED</div>
                    </div>
                    <h2 class="villain-capture-title">${currentCase.villainName}</h2>
                    <p class="villain-capture-subtitle">"${currentCase.villainTitle}"</p>
                `;
            } else {
                // Not all correct - villain escaped
                modalContent = `
                    <div class="villain-capture">
                        <img src="${currentCase.villainImageUrl || `https://ui-avatars.com/api/?name=${encodeURIComponent(currentCase.villainName.charAt(0))}&size=200&background=7c2d12&color=fff&bold=true&rounded=false`}" alt="${currentCase.villainName}" class="villain-capture-image">
                    </div>
                    <h2 class="villain-escape-title">SUSPECT ESCAPED</h2>
                    <p class="villain-escape-subtitle">The suspect remains at large. Try again to capture them!</p>
                `;
            }
            
            // Add statistics
            modalContent += `
                <div class="game-stats">
                    <div class="stat-row">
                        <span class="stat-label">Locations Found:</span>
                        <span class="stat-value">${correctLocations.filter(loc => loc).length} / 3</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Score:</span>
                        <span class="stat-value">${gameScore} points</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Time:</span>
                        <span class="stat-value">${minutes}:${seconds.toString().padStart(2, '0')}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Turns Used:</span>
                        <span class="stat-value">${currentTurn} / 5</span>
                    </div>
                </div>
            `;
            
            if (allCorrect) {
                modalContent += `<p class="interesting-fact">${currentCase.interestingFact}</p>`;
            }
            
            // Update modal
            document.getElementById('endGameHeader').textContent = allCorrect ? 'CASE SOLVED!' : 'CASE REMAINS OPEN';
            document.getElementById('endGameContent').innerHTML = modalContent;
            document.getElementById('endGameModal').classList.add('show');
            
            // Always save result (even partial results)
            saveGameResult(allCorrect, timeTaken);
        }
        
        async function saveGameResult(captured, timeTaken) {
            try {
                const result = {
                    caseId: currentCase.id,
                    captured: captured,
                    score: gameScore,
                    timeTaken: timeTaken,
                    turnsUsed: currentTurn,
                    locationsFound: correctLocations.filter(loc => loc).length,
                    timestamp: new Date().toISOString()
                };
                
                // Save to localStorage for now (will be replaced with API call)
                const savedResults = JSON.parse(localStorage.getItem('gameResults') || '[]');
                savedResults.push(result);
                localStorage.setItem('gameResults', savedResults);
                
                // TODO: Send to server API when implemented
                // await fetch('/api/results', { method: 'POST', body: JSON.stringify(result) });
                
            } catch (error) {
                console.error('Error saving game result:', error);
            }
        }
        
        function playAgain() {
            // Load a new random case
            window.location.href = window.location.pathname;
        }
        
        function viewResults() {
            // Navigate to results page with current case data
            const results = {
                caseId: currentCase.id,
                captured: correctLocations.every(loc => loc === true),
                score: gameScore,
                timeTaken: Math.floor((new Date() - gameStartTime) / 1000),
                turnsUsed: currentTurn,
                locationsFound: correctLocations.filter(loc => loc).length
            };
            
            // Store in sessionStorage for results page
            sessionStorage.setItem('lastGameResult', JSON.stringify(results));
            sessionStorage.setItem('lastGameCase', JSON.stringify(currentCase));
            
            window.location.href = '/result/?caseId=' + currentCase.id;
        }
        
        function closeEndGameModal() {
            document.getElementById('endGameModal').classList.remove('show');
        }

        function showEvidenceNotification(turn) {
            // Create floating notification
            const notification = document.createElement('div');
            notification.className = 'evidence-notification';
            notification.textContent = `Evidence added to case file (Turn ${turn})`;
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                notification.classList.add('hide');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function goToTurn(turn) {
            if (turn <= 5 && turn >= 1) {
                currentTurn = turn;
                updateTurnDisplay();
            }
        }

        function openImageModal(locationPosition, turn) {
            const location = currentCase.locations.find(loc => loc.position === locationPosition);
            if (!location) return;
            
            let imageUrl = null;
            let headerText = `Evidence Photo - Location ${locationPosition}`;
            
            // Get the appropriate image based on turn
            if (turn === 1 && location.images.turn1) {
                imageUrl = location.images.turn1;
                headerText += ` (Turn 1)`;
            } else if (turn === 3 && location.images.turn3 && currentTurn >= 3) {
                imageUrl = location.images.turn3;
                headerText += ` (Turn 3)`;
            } else if (turn === 5 && location.images.turn5 && currentTurn >= 5) {
                imageUrl = location.images.turn5;
                headerText += ` (Turn 5)`;
            }
            
            if (imageUrl) {
                document.getElementById('modalHeader').textContent = headerText;
                document.getElementById('modalImage').src = imageUrl;
                document.getElementById('imageModal').classList.add('show');
            }
        }
        
        function closeImageModal() {
            document.getElementById('imageModal').classList.remove('show');
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('imageModal');
            if (event.target === modal) {
                closeImageModal();
            }
        }

        function showTimezoneInfo() {
            const referenceLocation = currentCase.locations.find(loc => loc.position === 2);
            
            currentCase.locations.forEach(location => {
                const timezoneElement = document.getElementById(`timezone${location.position}`);
                const locationSection = document.getElementById(`place${location.position}`);
                
                if (location.position !== 2) {
                    const timeDiff = location.timezoneOffset - referenceLocation.timezoneOffset;
                    
                    // Handle decimal timezone offsets (like Nepal's +5.75)
                    let timezoneText;
                    if (timeDiff % 1 === 0) {
                        // Integer hours
                        timezoneText = timeDiff > 0 ? `+${timeDiff}h` : `${timeDiff}h`;
                    } else {
                        // Decimal hours (like +5.75)
                        const hours = Math.floor(Math.abs(timeDiff));
                        const minutes = Math.round((Math.abs(timeDiff) % 1) * 60);
                        const sign = timeDiff >= 0 ? '+' : '-';
                        timezoneText = `${sign}${hours}:${minutes.toString().padStart(2, '0')}`;
                    }
                    
                    timezoneElement.textContent = timezoneText;
                    timezoneElement.classList.remove('hidden');
                    timezoneElement.classList.add('show');
                    
                    if (timeDiff < 0) {
                        timezoneElement.classList.add('behind');
                        locationSection.classList.add('timezone-shift-left');
                    } else {
                        timezoneElement.classList.add('ahead');
                        locationSection.classList.add('timezone-shift-right');
                    }
                }
            });
        }
        
        function hideTimezoneInfo() {
            currentCase.locations.forEach(location => {
                const timezoneElement = document.getElementById(`timezone${location.position}`);
                const locationSection = document.getElementById(`place${location.position}`);
                
                if (timezoneElement) {
                    timezoneElement.classList.add('hidden');
                    timezoneElement.classList.remove('show', 'behind', 'ahead');
                }
                if (locationSection) {
                    locationSection.classList.remove('timezone-shift-left', 'timezone-shift-right');
                }
            });
        }
        
        function showDistanceSeparators() {
            const separators = document.querySelectorAll('.distance-separator');
            separators.forEach(separator => {
                separator.classList.add('visible');
            });
        }
        
        function hideDistanceSeparators() {
            const separators = document.querySelectorAll('.distance-separator');
            separators.forEach(separator => {
                separator.classList.remove('visible');
            });
        }
        
        function showTurn4Clue() {
            // Turn 4 clue is now handled in the timeline
            // No longer showing in Check Answers tab
        }
        
        function hideTurn4Clue() {
            // Turn 4 clue is now handled in the timeline
            // No longer showing in Check Answers tab
        }
        
        let cluesViewMode = 'timeline'; // Default view mode
        let timelineEntries = []; // Store all timeline entries
        
        function switchCluesView(mode) {
            cluesViewMode = mode;
            
            // Update toggle buttons
            document.querySelectorAll('.view-toggle-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.closest('.view-toggle-btn').classList.add('active');
            
            // Switch views
            if (mode === 'timeline') {
                document.getElementById('timelineView').classList.remove('hidden');
                document.getElementById('locationsView').classList.add('hidden');
                updateTimelineView();
            } else {
                document.getElementById('timelineView').classList.add('hidden');
                document.getElementById('locationsView').classList.remove('hidden');
                updateLocationsView();
            }
        }
        
        function addTimelineEntry(turn, type, content, data = {}) {
            // Store entry for both views
            timelineEntries.push({ turn, type, content, data, timestamp: Date.now() });
            
            // Update current view
            if (cluesViewMode === 'timeline') {
                updateTimelineView();
            } else {
                updateLocationsView();
            }
        }
        
        function updateTimelineView() {
            const container = document.getElementById('timelineContainer');
            if (!currentCase) return;
            
            let html = '';
            
            // Add initial case opening if not already there
            if (timelineEntries.length === 0 || timelineEntries[0].type !== 'case-opened') {
                timelineEntries.unshift({
                    turn: 0,
                    type: 'case-opened',
                    content: 'Case file opened. Initial evidence and witness reports collected from all three crime scenes.',
                    data: {},
                    timestamp: gameStartTime
                });
            }
            
            // Group entries by turn
            const entriesByTurn = {};
            timelineEntries.forEach(entry => {
                if (!entriesByTurn[entry.turn]) {
                    entriesByTurn[entry.turn] = [];
                }
                entriesByTurn[entry.turn].push(entry);
            });
            
            // Render each turn's entries
            Object.keys(entriesByTurn).sort((a, b) => a - b).forEach(turn => {
                const turnEntries = entriesByTurn[turn];
                const turnNum = parseInt(turn);
                
                html += `<div class="timeline-turn ${turnNum <= currentTurn ? 'active' : 'inactive'}">`;
                html += `<div class="timeline-turn-header">`;
                html += `<span class="turn-number">TURN ${turnNum === 0 ? '1' : turnNum}</span>`;
                html += `<span class="turn-title">${getTurnTitle(turnNum)}</span>`;
                html += `</div>`;
                
                turnEntries.forEach(entry => {
                    if (entry.type === 'text') {
                        html += `<div class="timeline-entry text-entry">`;
                        html += `<div class="entry-content">${entry.content}</div>`;
                        html += `</div>`;
                    } else if (entry.type === 'images' && entry.data.images) {
                        html += `<div class="timeline-entry images-entry">`;
                        html += `<div class="entry-label">Evidence Photos:</div>`;
                        html += `<div class="timeline-images">`;
                        entry.data.images.forEach((img, idx) => {
                            html += `
                                <div class="timeline-image" onclick="openImageModal(${idx + 1}, ${entry.data.turn})">
                                    <img src="${img}" alt="Location ${idx + 1}">
                                    <div class="timeline-image-overlay">
                                        <span>Location ${idx + 1}</span>
                                    </div>
                                </div>
                            `;
                        });
                        html += `</div></div>`;
                    } else if (entry.type === 'geographic' && entry.data.geographic) {
                        html += `<div class="timeline-entry geographic-entry">`;
                        html += `<div class="entry-label">Geographic Intelligence:</div>`;
                        html += `<div class="geographic-summary">`;
                        
                        // Distances
                        html += `<div class="summary-item">`;
                        html += `<span class="summary-label">Distances:</span>`;
                        entry.data.geographic.distances.forEach(d => {
                            html += `<span class="distance-inline">${d.name}: ${d.km}km / ${d.miles}mi</span>`;
                        });
                        html += `</div>`;
                        
                        // Timezones
                        html += `<div class="summary-item">`;
                        html += `<span class="summary-label">Timezones:</span>`;
                        entry.data.geographic.timezones.forEach(tz => {
                            html += `<span class="timezone-inline">${tz.location}: ${tz.offset}</span>`;
                        });
                        html += `</div>`;
                        
                        html += `</div></div>`;
                    } else if (entry.type === 'breakthrough' && entry.data.clue) {
                        html += `<div class="timeline-entry breakthrough-entry">`;
                        html += `<div class="breakthrough-content">üîç BREAKTHROUGH: "${entry.data.clue}"</div>`;
                        html += `</div>`;
                    }
                });
                
                html += `</div>`;
            });
            
            container.innerHTML = html;
        }
        
        function updateLocationsView() {
            const container = document.getElementById('locationsDossiers');
            if (!currentCase || !currentCase.locations) return;
            
            let html = '';
            
            currentCase.locations.forEach((location, index) => {
                html += `<div class="location-dossier">`;
                html += `<div class="dossier-header">`;
                html += `<h4 class="dossier-title">Location ${location.position} Dossier</h4>`;
                html += `</div>`;
                
                // Evidence photos
                html += `<div class="dossier-section">`;
                html += `<h5 class="dossier-section-title">Evidence Photos</h5>`;
                html += `<div class="dossier-images">`;
                
                [1, 3, 5].forEach(turn => {
                    const imageKey = `turn${turn}`;
                    const imageUrl = location.images && location.images[imageKey];
                    
                    if (imageUrl && currentTurn >= turn) {
                        html += `
                            <div class="dossier-image turn-${turn}" onclick="openImageModal(${location.position}, ${turn})">
                                <img src="${imageUrl}" alt="Turn ${turn}">
                                <div class="dossier-image-label">Turn ${turn}</div>
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="dossier-image placeholder">
                                <div class="placeholder-content">Turn ${turn}</div>
                            </div>
                        `;
                    }
                });
                
                html += `</div></div>`;
                
                // Geographic info (only show after turn 2)
                if (currentTurn >= 2) {
                    html += `<div class="dossier-section">`;
                    html += `<h5 class="dossier-section-title">Geographic Data</h5>`;
                    
                    // Timezone
                    const offsetHours = location.timezoneOffset;
                    const offsetText = offsetHours >= 0 ? `+${offsetHours}` : `${offsetHours}`;
                    html += `<div class="dossier-info">`;
                    html += `<span class="info-label">Timezone:</span> UTC${offsetText} (${location.timezoneName})`;
                    html += `</div>`;
                    
                    // Distances to other locations
                    currentCase.locations.forEach((otherLoc, otherIdx) => {
                        if (otherIdx !== index) {
                            const distance = calculateDistance(
                                location.latitude, location.longitude,
                                otherLoc.latitude, otherLoc.longitude
                            );
                            const distanceKm = Math.round(distance);
                            const distanceMiles = Math.round(distance * 0.621371);
                            
                            html += `<div class="dossier-info">`;
                            html += `<span class="info-label">To Location ${otherLoc.position}:</span> `;
                            html += `${distanceKm.toLocaleString()} km / ${distanceMiles.toLocaleString()} mi`;
                            html += `</div>`;
                        }
                    });
                    
                    html += `</div>`;
                }
                
                html += `</div>`;
            });
            
            container.innerHTML = html;
        }
        
        function getTurnTitle(turn) {
            const titles = {
                0: 'CASE OPENED',
                1: 'INITIAL INVESTIGATION',
                2: 'GEOGRAPHIC ANALYSIS',
                3: 'ENHANCED SURVEILLANCE',
                4: 'BREAKTHROUGH DISCOVERY',
                5: 'FINAL EVIDENCE'
            };
            return titles[turn] || `TURN ${turn}`;
        }
        
        function openEvidenceModal(locationPosition, turn) {
            // Reuse existing image modal functionality
            openImageModal(locationPosition, turn);
        }
        
        function showError(message) {
            document.getElementById('loadingContainer').classList.add('hidden');
            document.getElementById('errorContainer').classList.remove('hidden');
            document.getElementById('errorContainer').classList.add('show-flex');
            document.querySelector('#errorContainer p').textContent = message;
        }
        
        // Google Authentication
        let currentUser = null;
        
        // Initialize Google Sign-In after page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is already signed in
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                updateUserUI();
            }
        });
        
        // Initialize Google Sign-In when script loads
        async function initializeGoogleSignIn() {
            if (typeof google !== 'undefined' && google.accounts) {
                try {
                    // Fetch Google Client ID from server
                    const configResponse = await fetch('/api/config');
                    const config = await configResponse.json();
                    
                    if (config.googleClientId) {
                        google.accounts.id.initialize({
                            client_id: config.googleClientId,
                            callback: handleCredentialResponse,
                            auto_select: false,
                            cancel_on_tap_outside: true
                        });
                    } else {
                        console.error('Google Client ID not configured on server');
                    }
                } catch (error) {
                    console.error('Failed to load Google Client ID:', error);
                }
            } else {
                // Retry after a short delay if Google script hasn't loaded yet
                setTimeout(initializeGoogleSignIn, 100);
            }
        }
        
        // Start initialization
        initializeGoogleSignIn();
        
        function signIn() {
            if (typeof google === 'undefined' || !google.accounts) {
                console.error('Google Sign-In not loaded');
                alert('Google Sign-In is not available. Please try refreshing the page.');
                return;
            }
            
            // Skip One Tap and go directly to popup to avoid FedCM issues
            renderSignInButton();
        }
        
        function renderSignInButton() {
            // Create a temporary container for the sign-in button
            const tempContainer = document.createElement('div');
            tempContainer.id = 'tempSignInContainer';
            tempContainer.className = 'sign-in-modal-container';
            
            tempContainer.innerHTML = `
                <h3 class="sign-in-modal-title">Sign In to Worldwide Chase</h3>
                <div id="googleSignInButton"></div>
                <button onclick="closeSignInModal()" class="sign-in-cancel-button">Cancel</button>
            `;
            
            document.body.appendChild(tempContainer);
            
            // Render Google Sign-In button
            google.accounts.id.renderButton(
                document.getElementById('googleSignInButton'),
                {
                    theme: 'outline',
                    size: 'large',
                    text: 'signin_with',
                    shape: 'rectangular'
                }
            );
        }
        
        function closeSignInModal() {
            const modal = document.getElementById('tempSignInContainer');
            if (modal) {
                modal.remove();
            }
        }
        
        function handleCredentialResponse(response) {
            // Close sign-in modal if open
            closeSignInModal();
            
            // Decode JWT token
            const responsePayload = decodeJwtResponse(response.credential);
            
            const googleUser = {
                id: responsePayload.sub,
                fullName: responsePayload.name,
                email: responsePayload.email,
                picture: responsePayload.picture,
                firstName: responsePayload.given_name || responsePayload.name.split(' ')[0]
            };
            
            // Check if this is a new user
            const existingUser = localStorage.getItem(`user_${googleUser.id}`);
            
            if (!existingUser) {
                // New user - show signup modal
                showSignupModal(googleUser);
            } else {
                // Existing user - load their profile
                currentUser = JSON.parse(existingUser);
                // Update with latest Google info
                currentUser.fullName = googleUser.fullName;
                currentUser.email = googleUser.email;
                currentUser.picture = googleUser.picture;
                
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                localStorage.setItem(`user_${currentUser.id}`, JSON.stringify(currentUser));
                
                updateUserUI();
                savePendingGameResult();
            }
        }
        
        function showSignupModal(googleUser) {
            const modal = document.createElement('div');
            modal.id = 'signupModal';
            modal.className = 'signup-modal';
            
            modal.innerHTML = `
                <div class="signup-modal-content">
                    <h2 class="signup-modal-title">Welcome to Worldwide Chase!</h2>
                    <p class="signup-modal-text">Choose a username for your detective profile:</p>
                    
                    <div class="signup-input-container">
                        <label class="signup-input-label">Username:</label>
                        <input type="text" id="usernameInput" value="${googleUser.firstName}" class="signup-input" maxlength="20" placeholder="Enter username">
                        <small class="signup-input-hint">This will be displayed on leaderboards and your profile</small>
                    </div>
                    
                    <div class="signup-button-container">
                        <button onclick="completeSignup()" class="signup-button">Start Playing</button>
                        <button onclick="cancelSignup()" class="signup-cancel-button">Cancel</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Store google user data temporarily
            window.tempGoogleUser = googleUser;
            
            // Focus on username input
            setTimeout(() => {
                const input = document.getElementById('usernameInput');
                input.focus();
                input.select();
                
                // Allow Enter key to complete signup
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        completeSignup();
                    }
                });
            }, 100);
        }
        
        function completeSignup() {
            const username = document.getElementById('usernameInput').value.trim();
            if (!username) {
                alert('Please enter a username');
                return;
            }
            
            const googleUser = window.tempGoogleUser;
            
            currentUser = {
                id: googleUser.id,
                username: username,
                fullName: googleUser.fullName,
                email: googleUser.email,
                picture: googleUser.picture,
                joinedAt: new Date().toISOString()
            };
            
            // Save user profile
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            localStorage.setItem(`user_${currentUser.id}`, JSON.stringify(currentUser));
            
            // Close modal
            closeSignupModal();
            
            // Update UI
            updateUserUI();
            
            // Save any pending game results
            savePendingGameResult();
            
            // Clean up temp data
            delete window.tempGoogleUser;
        }
        
        function cancelSignup() {
            closeSignupModal();
            delete window.tempGoogleUser;
        }
        
        function closeSignupModal() {
            const modal = document.getElementById('signupModal');
            if (modal) {
                modal.remove();
            }
        }
        
        function decodeJwtResponse(token) {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }
        
        function updateUserUI() {
            const userMenuText = document.getElementById('userMenuText');
            const signedOutMenu = document.getElementById('signedOutMenu');
            const signedInMenu = document.getElementById('signedInMenu');
            const menuUserName = document.getElementById('menuUserName');
            
            if (currentUser) {
                // Update button text to show username
                userMenuText.textContent = currentUser.username || currentUser.name || currentUser.fullName;
                
                // Show signed-in menu, hide signed-out menu
                signedOutMenu.classList.add('hidden');
                signedInMenu.classList.remove('hidden');
                signedInMenu.classList.add('show');
                
                // Update user name in menu
                menuUserName.textContent = `Detective ${currentUser.username || currentUser.name || currentUser.fullName}`;
            } else {
                // Show "Sign In" text
                userMenuText.textContent = 'Sign In';
                
                // Show signed-out menu, hide signed-in menu
                signedOutMenu.classList.remove('hidden');
                signedOutMenu.classList.add('show');
                signedInMenu.classList.add('hidden');
            }
        }
        
        async function savePendingGameResult() {
            // Check if there's a pending result to save
            const pendingResult = sessionStorage.getItem('pendingGameResult');
            if (pendingResult && currentUser) {
                const result = JSON.parse(pendingResult);
                result.userId = currentUser.id;
                result.userName = currentUser.name;
                
                try {
                    // TODO: Send to server API when implemented
                    // await fetch('/api/results', {
                    //     method: 'POST',
                    //     headers: { 'Content-Type': 'application/json' },
                    //     body: JSON.stringify(result)
                    // });
                    
                    // For now, save to localStorage
                    const userResults = JSON.parse(localStorage.getItem(`userResults_${currentUser.id}`) || '[]');
                    userResults.push(result);
                    localStorage.setItem(`userResults_${currentUser.id}`, JSON.stringify(userResults));
                    
                    sessionStorage.removeItem('pendingGameResult');
                } catch (error) {
                    console.error('Error saving game result:', error);
                }
            }
        }
        
        // Update saveGameResult to handle user authentication
        const originalSaveGameResult = saveGameResult;
        saveGameResult = async function(captured, timeTaken) {
            const result = {
                caseId: currentCase.id,
                captured: captured,
                score: gameScore,
                timeTaken: timeTaken,
                turnsUsed: currentTurn,
                locationsFound: correctLocations.filter(loc => loc).length,
                timestamp: new Date().toISOString()
            };
            
            if (currentUser) {
                result.userId = currentUser.id;
                result.userName = currentUser.name;
                
                // Save to user-specific storage
                const userResults = JSON.parse(localStorage.getItem(`userResults_${currentUser.id}`) || '[]');
                userResults.push(result);
                localStorage.setItem(`userResults_${currentUser.id}`, JSON.stringify(userResults));
            } else {
                // Save as pending if not signed in
                sessionStorage.setItem('pendingGameResult', JSON.stringify(result));
            }
            
            // Also save to general results
            const savedResults = JSON.parse(localStorage.getItem('gameResults') || '[]');
            savedResults.push(result);
            localStorage.setItem('gameResults', JSON.stringify(savedResults));
        };

        // User Menu Functions
        function toggleUserMenu() {
            const button = document.getElementById('userMenuButton');
            const dropdown = document.getElementById('userMenuDropdown');
            const isOpen = !dropdown.classList.contains('hidden');
            
            if (isOpen) {
                dropdown.classList.add('hidden');
                dropdown.classList.remove('show');
                button.classList.remove('open');
            } else {
                dropdown.classList.remove('hidden');
                dropdown.classList.add('show');
                button.classList.add('open');
            }
        }

        // Close user menu when clicking outside
        document.addEventListener('click', function(event) {
            const userMenuContainer = document.getElementById('userMenuContainer');
            if (userMenuContainer && !userMenuContainer.contains(event.target)) {
                const dropdown = document.getElementById('userMenuDropdown');
                const button = document.getElementById('userMenuButton');
                if (dropdown && !dropdown.classList.contains('hidden')) {
                    dropdown.classList.add('hidden');
                    dropdown.classList.remove('show');
                    button.classList.remove('open');
                }
            }
        });

        // Help Modal Functions
        function showHelpModal() {
            document.getElementById('helpModal').classList.add('show');
            // Close user menu if open
            const dropdown = document.getElementById('userMenuDropdown');
            const button = document.getElementById('userMenuButton');
            if (dropdown && !dropdown.classList.contains('hidden')) {
                dropdown.classList.add('hidden');
                dropdown.classList.remove('show');
                button.classList.remove('open');
            }
        }

        function closeHelpModal() {
            document.getElementById('helpModal').classList.remove('show');
        }

        // Close help modal when clicking outside
        document.getElementById('helpModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeHelpModal();
            }
        });

        // Close modals with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const helpModal = document.getElementById('helpModal');
                const profileModal = document.getElementById('profileModal');
                if (helpModal.classList.contains('show')) {
                    closeHelpModal();
                }
                if (profileModal.classList.contains('show')) {
                    closeProfileModal();
                }
            }
        });

        // Profile Modal Functions
        function showProfileModal() {
            updateProfileDisplay();
            document.getElementById('profileModal').classList.add('show');
            // Close user menu if open
            const dropdown = document.getElementById('userMenuDropdown');
            const button = document.getElementById('userMenuButton');
            if (dropdown && !dropdown.classList.contains('hidden')) {
                dropdown.classList.add('hidden');
                dropdown.classList.remove('show');
                button.classList.remove('open');
            }
        }

        function closeProfileModal() {
            document.getElementById('profileModal').classList.remove('show');
        }

        // Close profile modal when clicking outside
        document.getElementById('profileModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeProfileModal();
            }
        });

        function updateProfileDisplay() {
            const editButton = document.getElementById('editUsernameBtn');
            
            if (currentUser) {
                // Show username instead of full name
                document.getElementById('profileUserName').textContent = currentUser.username || currentUser.name || currentUser.fullName;
                document.getElementById('profileUserEmail').textContent = currentUser.email || '';
                
                // Show edit button when user is logged in
                editButton.classList.remove('hidden');
                
                // Get user stats
                const userResults = JSON.parse(localStorage.getItem(`userResults_${currentUser.id}`) || '[]');
                const casesPlayed = userResults.length;
                
                document.getElementById('profileCasesPlayed').textContent = `Cases Solved: ${casesPlayed}`;
                
                if (casesPlayed > 0) {
                    const averageScore = Math.round(userResults.reduce((sum, result) => sum + result.score, 0) / casesPlayed);
                    const bestTime = Math.min(...userResults.map(result => result.timeTaken));
                    const bestTimeMinutes = Math.floor(bestTime / 60);
                    const bestTimeSeconds = bestTime % 60;
                    
                    document.getElementById('profileAverageScore').textContent = `Average Score: ${averageScore}`;
                    document.getElementById('profileBestTime').textContent = `Best Time: ${bestTimeMinutes}m ${bestTimeSeconds}s`;
                } else {
                    document.getElementById('profileAverageScore').textContent = 'Average Score: N/A';
                    document.getElementById('profileBestTime').textContent = 'Best Time: N/A';
                }
            } else {
                document.getElementById('profileUserName').textContent = 'Sign in to track your progress';
                document.getElementById('profileUserEmail').textContent = 'N/A';
                document.getElementById('profileCasesPlayed').textContent = 'Cases Solved: 0';
                document.getElementById('profileAverageScore').textContent = 'Average Score: N/A';
                document.getElementById('profileBestTime').textContent = 'Best Time: N/A';
                
                // Hide edit button when not logged in
                editButton.classList.add('hidden');
            }
        }

        // Sign out function
        function signOut() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            updateUserUI();
            // Close user menu
            const dropdown = document.getElementById('userMenuDropdown');
            const button = document.getElementById('userMenuButton');
            if (dropdown) {
                dropdown.classList.add('hidden');
                dropdown.classList.remove('show');
                button.classList.remove('open');
            }
        }

        // First-time visit detection and auto-show help
        function checkFirstTimeVisit() {
            // Temporarily disabled auto-show to fix loading issues
            // Will re-enable after confirming manual help access works properly
            /*
            const hasVisited = localStorage.getItem('hasVisitedWorldwideChase');
            if (!hasVisited) {
                localStorage.setItem('hasVisitedWorldwideChase', 'true');
                // Show help modal after a short delay, only if no other modals are open
                setTimeout(() => {
                    const helpModal = document.getElementById('helpModal');
                    const profileModal = document.getElementById('profileModal');
                    // Only show help if neither modal is already open
                    if (!helpModal.classList.contains('show') && !profileModal.classList.contains('show')) {
                        showHelpModal();
                    }
                }, 2000);
            }
            */
        }

        // Edit Username Modal Functions
        function showEditUsernameModal() {
            if (!currentUser) return;
            
            const modal = document.getElementById('editUsernameModal');
            const input = document.getElementById('usernameEditInput');
            
            // Pre-fill with current username
            input.value = currentUser.username || currentUser.name || currentUser.fullName;
            
            modal.classList.add('show');
            
            // Focus and select the input
            setTimeout(() => {
                input.focus();
                input.select();
            }, 100);
        }

        function closeEditUsernameModal() {
            document.getElementById('editUsernameModal').classList.remove('show');
        }

        function saveUsername() {
            const newUsername = document.getElementById('usernameEditInput').value.trim();
            
            if (!newUsername) {
                alert('Please enter a username');
                return;
            }
            
            if (newUsername.length < 2) {
                alert('Username must be at least 2 characters long');
                return;
            }
            
            if (newUsername.length > 20) {
                alert('Username must be 20 characters or less');
                return;
            }
            
            // Update current user
            currentUser.username = newUsername;
            
            // Save to localStorage
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            localStorage.setItem(`user_${currentUser.id}`, JSON.stringify(currentUser));
            
            // Update UI
            updateUserUI();
            updateProfileDisplay();
            
            // Close modal
            closeEditUsernameModal();
        }

        // Close edit username modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('editUsernameModal');
            if (event.target === modal) {
                closeEditUsernameModal();
            }
        });

        // Allow Enter key to save username
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                const modal = document.getElementById('editUsernameModal');
                if (modal.classList.contains('show')) {
                    saveUsername();
                }
            }
        });

        // Villain Modal Functions
        function showVillainModal() {
            if (!gameData) return;
            
            const modal = document.getElementById('villainModal');
            const villainImage = document.getElementById('villainModalImage');
            const villainName = document.getElementById('villainModalName');
            const villainTitle = document.getElementById('villainModalTitle');
            
            // Set villain information
            villainImage.src = gameData.villainImageUrl || '/game/wwc-logo.png';
            villainName.textContent = gameData.villainName || 'Unknown Suspect';
            villainTitle.textContent = gameData.villainTitle || 'Criminal Mastermind';
            
            modal.classList.add('show');
        }

        function closeVillainModal() {
            document.getElementById('villainModal').classList.remove('show');
        }

        // Close villain modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('villainModal');
            if (event.target === modal) {
                closeVillainModal();
            }
        });

        // Add Escape key handler for villain modal
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const villainModal = document.getElementById('villainModal');
                if (villainModal && villainModal.classList.contains('show')) {
                    closeVillainModal();
                }
            }
        });
    </script>

    <!-- Help Modal -->
    <div id="helpModal" class="help-modal">
        <div class="help-modal-content">
            <button class="help-close" onclick="closeHelpModal()">&times;</button>
            <div class="help-modal-header">How to Play</div>
            <div class="help-content">
                <div class="help-section">
                    <h3>üîç Mission</h3>
                    <p>Identify 3 connected locations using clues.</p>
                </div>

                <div class="help-section">
                    <h3>üé≤ Turns</h3>
                    <ul>
                        <li><span class="help-turn-indicator">T1</span>Theme + photos</li>
                        <li><span class="help-turn-indicator">T2</span>Timezones</li>
                        <li><span class="help-turn-indicator">T3</span>Clearer photos</li>
                        <li><span class="help-turn-indicator">T4</span>Extra clue</li>
                        <li><span class="help-turn-indicator">T5</span>Final photos</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3>üïµÔ∏è Tips</h3>
                    <ul>
                        <li>Click photos to zoom</li>
                        <li>Use theme & Turn 4 clue</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="profile-modal">
        <div class="profile-modal-content">
            <button class="profile-close" onclick="closeProfileModal()">&times;</button>
            <div class="profile-modal-header">Detective Profile</div>
            <div class="profile-content">
                <div class="help-section">
                    <h3>üë§ Account Details</h3>
                    <div class="profile-field">
                        <span><strong>Username:</strong> <span id="profileUserName">Sign in to track your progress</span></span>
                        <button id="editUsernameBtn" class="edit-button hidden" onclick="showEditUsernameModal()">Edit</button>
                    </div>
                    <div class="profile-field">
                        <span><strong>Email:</strong> <span id="profileUserEmail">N/A</span></span>
                    </div>
                </div>

                <div class="help-section">
                    <h3>üìä Detective Stats</h3>
                    <p id="profileCasesPlayed">Cases Solved: 0</p>
                    <p id="profileAverageScore">Average Score: N/A</p>
                    <p id="profileBestTime">Best Time: N/A</p>
                </div>

                <div class="help-section">
                    <h3>üéñÔ∏è Achievements</h3>
                    <p>Coming soon - Track your detective accomplishments!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Username Modal -->
    <div id="editUsernameModal" class="edit-username-modal">
        <div class="edit-username-content">
            <div class="edit-username-header">Edit Username</div>
            <input type="text" id="usernameEditInput" class="username-input" placeholder="Enter new username" maxlength="20">
            <div class="edit-username-buttons">
                <button class="save-username-btn" onclick="saveUsername()">Save</button>
                <button class="cancel-username-btn" onclick="closeEditUsernameModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Villain Image Modal -->
    <div id="villainModal" class="villain-modal">
        <div class="villain-modal-content">
            <button class="villain-modal-close" onclick="closeVillainModal()">&times;</button>
            <div class="villain-modal-header">Suspect Profile</div>
            <img id="villainModalImage" class="villain-modal-image" src="" alt="Villain Portrait">
            <div class="villain-modal-info">
                <div id="villainModalName" class="villain-modal-name"></div>
                <div id="villainModalTitle" class="villain-modal-title"></div>
            </div>
        </div>
    </div>

    <!-- Detective Header Partial -->
    <script src="detective-header.js"></script>

</body>
</html>